version: "0.5"

processes:
  redis:
    command: echo 'requirepass changeme!' | keydb-server - --save "" --appendonly no

  marshal_0:
    command: cargo run --package cdn-marshal --release -- -d "redis://:changeme!@localhost:6379"

  broker_0:
    command: cargo run --package cdn-broker --release -- -d "redis://:changeme!@localhost:6379"

  broker_1:
    command: cargo run --package cdn-broker --release -- 
      --public-bind-address 0.0.0.0:1740
      --public-advertise-address local_ip:1740
      --private-bind-address 0.0.0.0:1741
      --private-advertise-address local_ip:1741
      -d "redis://:changeme!@localhost:6379"

  client_0:
    command: cargo run --bin cdn-client --release -- -m "127.0.0.1:1737"
    depends_on:
      marshal_0:
        condition: process_started